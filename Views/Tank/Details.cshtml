@model AquaHub.MVC.Models.Tank

@{
    ViewData["Title"] = Model.Name;
}

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a asp-action="Index">Tanks</a></li>
                    <li class="breadcrumb-item active">@Model.Name</li>
                </ol>
            </nav>
        </div>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i>@TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm mb-4">
                @{
                    var tankImage = ViewData["TankImage"] as string;
                }
                @* Debug info - remove in production *@
                @if (string.IsNullOrEmpty(tankImage))
                {
                    <div class="alert alert-info">
                        <small>No image available. ImageData: @(Model.ImageData?.Length ?? 0) bytes, Type: @(Model.ImageType
                                                                                                            ?? "null")</small>
                        </div>
                    }
                else
                    {
                        <img src="@tankImage" class="card-img-top" alt="@Model.Name"
                             style="max-height: 400px; object-fit: cover;"
                             onerror="console.error('Failed to load tank image'); this.style.display='none';">
                    }
                    <div class="card-body">
                        <h2 class="card-title display-6 fw-bold mb-3">@Model.Name</h2>

                        <div class="d-flex gap-2 mb-3">
                            <span class="badge bg-info text-dark fs-6">
                                <i class="bi bi-tag-fill"></i> @Model.Type
                            </span>
                            <span class="badge bg-secondary fs-6">
                                <i class="bi bi-rulers"></i> @Model.VolumeGallons gal
                            </span>
                        </div>

                        <hr />
                        <!-- Tank Milestones Section -->
                        @if (Model.TankMilestones != null && Model.TankMilestones.Any())
                        {
                            var currentMilestone = Model.TankMilestones.FirstOrDefault(m => !m.IsCompleted);
                            var nextMilestone = Model.TankMilestones.SkipWhile(m => !m.IsCompleted).FirstOrDefault(m => !m.IsCompleted && m != currentMilestone);
                            <div class="card border-0 shadow-sm mb-4">
                                <div class="card-header bg-white border-bottom">
                                    <h6 class="mb-0 fw-bold"><i class="bi bi-flag text-success"></i> Tank Milestones</h6>
                                    @if (currentMilestone != null)
                                    {
                                        <span class="badge bg-warning ms-2">Current: @currentMilestone.Type</span>
                                    }
                                    @if (nextMilestone != null)
                                    {
                                        <span class="badge bg-info ms-2">Next: @nextMilestone.Type</span>
                                    }
                                </div>
                                <div class="card-body p-3">
                                    <ul class="list-group list-group-flush">
                                        @foreach (var milestone in Model.TankMilestones)
                                        {
                                            var statusClass = milestone.IsCompleted ? "text-success" : (milestone.TargetDate < DateTime.UtcNow ? "text-danger" : "text-secondary");
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                <div>
                                                    <i class="bi bi-flag-fill @statusClass me-2"></i>
                                                    <span class="fw-bold">@milestone.Type</span>
                                                    <span class="ms-2">@milestone.Description</span>
                                                    @if (milestone.TargetDate.HasValue)
                                                    {
                                                        <span class="badge bg-light text-dark ms-2">Target: @milestone.TargetDate.Value.ToString("MMM dd, yyyy")</span>
                                                    }
                                                    @if (milestone.IsCompleted && milestone.CompletedDate.HasValue)
                                                    {
                                                        <span class="badge bg-success ms-2">Completed: @milestone.CompletedDate.Value.ToString("MMM dd, yyyy")</span>
                                                    }
                                                    @if (milestone.IsManuallyCompleted && milestone.ManualCompletedDate.HasValue)
                                                    {
                                                        <span class="badge bg-primary ms-2">Manually Completed: @milestone.ManualCompletedDate.Value.ToString("MMM dd, yyyy")</span>
                                                    }
                                                </div>
                                                <div class="d-flex gap-2">
                                                    @if (!milestone.IsCompleted)
                                                    {
                                                        <form asp-action="MarkMilestoneComplete" method="post" asp-route-milestoneId="@milestone.Id" class="d-inline">
                                                            <button type="submit" class="btn btn-sm btn-outline-success">Mark Complete</button>
                                                        </form>
                                                    }
                                                    @if (milestone.IsManuallyCompleted)
                                                    {
                                                        <form asp-action="ResetMilestone" method="post" asp-route-milestoneId="@milestone.Id" class="d-inline">
                                                            <button type="submit" class="btn btn-sm btn-outline-warning">Reset</button>
                                                        </form>
                                                    }
                                                    @if (!milestone.IsCompleted)
                                                    {
                                                        <span class="badge bg-warning text-dark">Pending</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-success">Done</span>
                                                    }
                                                </div>
                                            </li>
                                        }
                                    </ul>
                                </div>
                            </div>
                        }

                        <dl class="row">
                            <dt class="col-sm-3">Setup Date:</dt>
                            <dd class="col-sm-9">@Model.StartDate.ToString("MMMM dd, yyyy")</dd>

                            <dt class="col-sm-3">Age:</dt>
                            <dd class="col-sm-9">@((DateTime.Now - Model.StartDate).Days) days</dd>

                            @if (!string.IsNullOrEmpty(Model.Notes))
                            {
                                <dt class="col-sm-3">Notes:</dt>
                                <dd class="col-sm-9">@Model.Notes</dd>
                            }

                            @if (Model.IsQuarantineTank)
                            {
                                <dt class="col-sm-3">Quarantine Status:</dt>
                                <dd class="col-sm-9">
                                    <span class="badge bg-warning text-dark">
                                        <i class="bi bi-shield-exclamation"></i> Quarantine Tank
                                    </span>
                                    @if (!string.IsNullOrEmpty(Model.QuarantineStatus))
                                    {
                                        <span class="badge bg-info">@Model.QuarantineStatus</span>
                                    }
                                </dd>

                                @if (Model.QuarantineStartDate.HasValue)
                                {
                                    <dt class="col-sm-3">Quarantine Start:</dt>
                                    <dd class="col-sm-9">
                                        @Model.QuarantineStartDate.Value.ToString("MMMM dd, yyyy")
                                        <small class="text-muted">
                                            (@((DateTime.Now - Model.QuarantineStartDate.Value).Days) days)
                                        </small>
                                    </dd>
                                }

                                @if (!string.IsNullOrEmpty(Model.QuarantinePurpose))
                                {
                                    <dt class="col-sm-3">Purpose:</dt>
                                    <dd class="col-sm-9">@Model.QuarantinePurpose</dd>
                                }
                            }
                        </dl>
                    </div>
                    <div class="card-footer bg-transparent">
                        <div class="btn-group" role="group">
                            <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-warning">
                                <i class="bi bi-pencil"></i> Edit
                            </a>
                            <a asp-action="Delete" asp-route-id="@Model.Id" class="btn btn-danger">
                                <i class="bi bi-trash"></i> Delete
                            </a>
                        </div>
                        <div class="float-end">
                            @if (Model.IsQuarantineTank)
                            {
                                <a asp-action="QuarantineDashboard" asp-route-id="@Model.Id" class="btn btn-warning me-2">
                                    <i class="bi bi-shield-exclamation"></i> Quarantine Dashboard
                                </a>
                            }
                            <a asp-action="Dashboard" asp-route-id="@Model.Id" class="btn btn-primary">
                                <i class="bi bi-speedometer2"></i> View Dashboard
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                @{
                    var latestWaterTest = ViewData["LatestWaterTest"] as AquaHub.MVC.Models.WaterTest;
                }

                @if (latestWaterTest != null)
                {
                    var isSaltwater = Model.Type == AquaHub.MVC.Models.Enums.AquariumType.Saltwater || 
                                      Model.Type == AquaHub.MVC.Models.Enums.AquariumType.Reef || 
                                      Model.Type == AquaHub.MVC.Models.Enums.AquariumType.NanoReef;
                    
                    <!-- Water Quality Status Card -->
                    <div class="card border-0 shadow-sm mb-3">
                        <div class="card-header bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <h5 class="mb-0">
                                <i class="bi bi-water"></i> Water Quality
                            </h5>
                            <small>Last tested: @latestWaterTest.Timestamp.ToString("MMM dd, yyyy")</small>
                        </div>
                        <div class="card-body p-2">
                            @{
                                var criticalParams = new List<(string Name, double? Value, double? MaxSafe, string Unit, string Icon)>
                                {
                                    ("Ammonia", latestWaterTest.Ammonia, 0.0, "ppm", "bi-exclamation-octagon-fill"),
                                    ("Nitrite", latestWaterTest.Nitrite, 0.0, "ppm", "bi-exclamation-triangle-fill"),
                                    ("Nitrate", latestWaterTest.Nitrate, isSaltwater ? 20.0 : 40.0, "ppm", "bi-info-circle-fill")
                                };
                                
                                foreach (var param in criticalParams.Where(p => p.Value.HasValue))
                                {
                                    var value = param.Value!.Value;
                                    var maxSafe = param.MaxSafe!.Value;
                                    var isGood = value <= maxSafe;
                                    var percentage = maxSafe > 0 ? Math.Min(100, (value / (maxSafe * 2)) * 100) : (value == 0 ? 0 : 100);
                                    var gaugeColor = isGood ? "success" : "danger";
                                    
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <small class="fw-bold">
                                                <i class="bi @param.Icon text-@gaugeColor"></i> @param.Name
                                            </small>
                                            <span class="badge bg-@gaugeColor">@value.ToString("F2") @param.Unit</span>
                                        </div>
                                        <div class="progress" style="height: 10px;">
                                            <div class="progress-bar bg-@gaugeColor @(!isGood ? "progress-bar-striped progress-bar-animated" : "")" 
                                                 role="progressbar" 
                                                 style="width: @percentage.ToString("F0")%" 
                                                 aria-valuenow="@percentage" aria-valuemin="0" aria-valuemax="100">
                                            </div>
                                        </div>
                                        <small class="text-muted">Safe: ≤ @maxSafe @param.Unit</small>
                                    </div>
                                }
                                
                                // pH and Temperature
                                if (latestWaterTest.PH.HasValue)
                                {
                                    var ph = latestWaterTest.PH.Value;
                                    var phMin = isSaltwater ? 8.1 : 6.5;
                                    var phMax = isSaltwater ? 8.4 : 7.5;
                                    var phGood = ph >= phMin && ph <= phMax;
                                    
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <small class="fw-bold">
                                                <i class="bi bi-droplet-half text-@(phGood ? "success" : "warning")"></i> pH
                                            </small>
                                            <span class="badge bg-@(phGood ? "success" : "warning")">@ph.ToString("F2")</span>
                                        </div>
                                        <div class="progress" style="height: 10px;">
                                            @{
                                                var phRange = phMax - phMin;
                                                var phPosition = ((ph - phMin) / phRange) * 100;
                                                phPosition = Math.Max(0, Math.Min(100, phPosition));
                                            }
                                            <div class="progress-bar bg-@(phGood ? "success" : "warning")" 
                                                 role="progressbar" 
                                                 style="width: @phPosition.ToString("F0")%" 
                                                 aria-valuenow="@phPosition" aria-valuemin="0" aria-valuemax="100">
                                            </div>
                                        </div>
                                        <small class="text-muted">Ideal: @phMin.ToString("F1") - @phMax.ToString("F1")</small>
                                    </div>
                                }
                                
                                if (latestWaterTest.Temperature.HasValue)
                                {
                                    var temp = latestWaterTest.Temperature.Value;
                                    var tempMin = isSaltwater ? 76.0 : 72.0;
                                    var tempMax = isSaltwater ? 82.0 : 78.0;
                                    var tempGood = temp >= tempMin && temp <= tempMax;
                                    
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <small class="fw-bold">
                                                <i class="bi bi-thermometer-half text-@(tempGood ? "success" : "warning")"></i> Temperature
                                            </small>
                                            <span class="badge bg-@(tempGood ? "success" : "warning")">@temp.ToString("F1")°F</span>
                                        </div>
                                        <div class="progress" style="height: 10px;">
                                            @{
                                                var tempRange = tempMax - tempMin;
                                                var tempPosition = ((temp - tempMin) / tempRange) * 100;
                                                tempPosition = Math.Max(0, Math.Min(100, tempPosition));
                                            }
                                            <div class="progress-bar bg-@(tempGood ? "success" : "warning")" 
                                                 role="progressbar" 
                                                 style="width: @tempPosition.ToString("F0")%" 
                                                 aria-valuenow="@tempPosition" aria-valuemin="0" aria-valuemax="100">
                                            </div>
                                        </div>
                                        <small class="text-muted">Ideal: @tempMin.ToString("F0")°F - @tempMax.ToString("F0")°F</small>
                                    </div>
                                }
                            }
                        </div>
                        <div class="card-footer bg-transparent text-center">
                            <a asp-controller="WaterTest" asp-action="Trends" asp-route-tankId="@Model.Id" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-graph-up"></i> View Trends
                            </a>
                            <a asp-controller="WaterTest" asp-action="Create" asp-route-tankId="@Model.Id" class="btn btn-sm btn-primary">
                                <i class="bi bi-plus-circle"></i> New Test
                            </a>
                        </div>
                    </div>
                }
                else
                {
                    <!-- No Water Test Available -->
                    <div class="card border-warning shadow-sm mb-3">
                        <div class="card-body text-center">
                            <i class="bi bi-droplet display-4 text-muted"></i>
                            <h6 class="mt-2">No Water Test Data</h6>
                            <p class="text-muted small">Log your first water test to monitor water quality</p>
                            <a asp-controller="WaterTest" asp-action="Create" asp-route-tankId="@Model.Id" class="btn btn-primary btn-sm">
                                <i class="bi bi-plus-circle"></i> Log Test
                            </a>
                        </div>
                    </div>
                }

                @if (Model.IsQuarantineTank)
                {
                    <div class="card border-warning shadow-sm mb-3">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0">
                                <i class="bi bi-shield-exclamation"></i> Quarantine Monitoring
                            </h5>
                        </div>
                        <div class="card-body">
                            <p class="card-text">
                                <strong>AI-Powered Care Dashboard</strong><br>
                                <small class="text-muted">
                                    Get intelligent recommendations for water chemistry, dosing protocols, and treatment
                                    monitoring.
                                </small>
                            </p>
                            <a asp-action="QuarantineDashboard" asp-route-id="@Model.Id" class="btn btn-warning w-100">
                                <i class="bi bi-shield-exclamation"></i> Open Quarantine Dashboard
                            </a>
                        </div>
                    </div>
                }

                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-speedometer"></i> Quick Actions</h5>
                    </div>
                    <div class="list-group list-group-flush">
                        <a asp-controller="Livestock" asp-action="Index" asp-route-tankId="@Model.Id"
                               class="list-group-item list-group-item-action">
                            <i class="bi bi-fish text-primary"></i> View Livestock
                        </a>
                        <a asp-controller="WaterTest" asp-action="Index" asp-route-tankId="@Model.Id"
                               class="list-group-item list-group-item-action">
                            <i class="bi bi-droplet text-info"></i> Water Tests
                        </a>
                        <a asp-controller="Equipment" asp-action="Index" asp-route-tankId="@Model.Id"
                               class="list-group-item list-group-item-action">
                            <i class="bi bi-gear text-warning"></i> Equipment
                        </a>
                        <a asp-controller="ShoppingList" asp-action="Index" asp-route-tankId="@Model.Id"
                               class="list-group-item list-group-item-action">
                            <i class="bi bi-cart text-primary"></i> Shopping List
                        </a>
                        <a asp-controller="MaintenanceLog" asp-action="Index" asp-route-tankId="@Model.Id"
                               class="list-group-item list-group-item-action">
                            <i class="bi bi-wrench text-success"></i> Maintenance Logs
                        </a>
                        <a asp-controller="Expense" asp-action="Index" asp-route-tankId="@Model.Id"
                               class="list-group-item list-group-item-action">
                            <i class="bi bi-cash text-danger"></i> Expenses
                        </a>
                    </div>
                </div>

                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-plus-circle"></i> Add New</h5>
                    </div>
                    <div class="list-group list-group-flush">
                        <a asp-controller="ShoppingList" asp-action="Create" asp-route-tankId="@Model.Id"
                               class="list-group-item list-group-item-action">
                            <i class="bi bi-cart-plus"></i> Add to Shopping List
                        </a>
                        <a asp-controller="Livestock" asp-action="Create" asp-route-tankId="@Model.Id"
                               class="list-group-item list-group-item-action">
                            <i class="bi bi-fish"></i> Add Livestock
                        </a>
                        <a asp-controller="WaterTest" asp-action="Create" asp-route-tankId="@Model.Id"
                               class="list-group-item list-group-item-action">
                            <i class="bi bi-droplet"></i> Log Water Test
                        </a>
                        <a asp-controller="Equipment" asp-action="Create" asp-route-tankId="@Model.Id"
                               class="list-group-item list-group-item-action">
                            <i class="bi bi-gear"></i> Add Equipment
                        </a>
                        <a asp-controller="MaintenanceLog" asp-action="Create" asp-route-tankId="@Model.Id"
                               class="list-group-item list-group-item-action">
                            <i class="bi bi-wrench"></i> Log Maintenance
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>