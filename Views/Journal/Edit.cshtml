@model AquaHub.MVC.Models.JournalEntry

@{
    ViewData["Title"] = "Edit Journal Entry";
}

<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-lg border-0 mb-4">
                <div class="card-header bg-warning text-dark">
                    <h2 class="mb-0">
                        <i class="bi bi-pencil-square"></i> Edit Journal Entry
                    </h2>
                </div>
                <div class="card-body p-4">
                    <form asp-action="Edit" enctype="multipart/form-data">
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>
                        <input type="hidden" asp-for="Id" />

                        <div class="mb-4">
                            <label asp-for="TankId" class="form-label fw-bold">
                                <i class="bi bi-droplet-fill text-info"></i> Tank
                            </label>
                            <select asp-for="TankId" class="form-select" asp-items="ViewBag.TankId">
                                <option value="">-- Select Tank --</option>
                            </select>
                            <span asp-validation-for="TankId" class="text-danger"></span>
                        </div>

                        <div class="mb-4">
                            <label asp-for="Timestamp" class="form-label fw-bold">
                                <i class="bi bi-calendar3 text-primary"></i> Date & Time
                            </label>
                            <input asp-for="Timestamp" type="datetime-local" class="form-control" />
                            <span asp-validation-for="Timestamp" class="text-danger"></span>
                        </div>

                        <div class="mb-4">
                            <label asp-for="Title" class="form-label fw-bold">
                                <i class="bi bi-card-heading text-success"></i> Title
                            </label>
                            <input asp-for="Title" class="form-control" />
                            <span asp-validation-for="Title" class="text-danger"></span>
                        </div>

                        <div class="mb-4">
                            <label asp-for="Content" class="form-label fw-bold">
                                <i class="bi bi-text-paragraph text-warning"></i> Entry Content
                            </label>
                            <textarea asp-for="Content" class="form-control" rows="10"></textarea>
                            <span asp-validation-for="Content" class="text-danger"></span>
                            <small class="form-text text-muted">Maximum 5000 characters</small>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="bi bi-image text-secondary"></i> Image (Optional)
                            </label>
                            @if (!string.IsNullOrEmpty(Model.ImagePath))
                            {
                                <div class="mb-2">
                                    <img src="@Model.ImagePath" alt="Journal Image" class="img-fluid rounded shadow-sm"
                                         style="max-height:200px;" />
                                </div>
                            }
                            <input type="file" name="ImageFile" id="imageInput" accept="image/*" capture="environment"
                                   class="form-control" />
                            <small class="form-text text-muted">Upload or take a new photo to replace the current image.
                                On mobile, you can use your camera.</small>
                                <div id="imagePreviewContainer" class="mt-3" style="display:none;">
                                    <label class="form-label">Preview &amp; Adjust:</label>
                                    <div style="max-width:300px;">
                                        <canvas id="imagePreviewCanvas"
                                                style="width:100%;border:1px solid #ccc;border-radius:8px;"></canvas>
                                    </div>
                                    <div class="mt-2">
                                        <label>Zoom:</label>
                                        <input type="range" id="imageZoom" min="1" max="3" step="0.01" value="1"
                                               style="width:150px;">
                                        <label>Position:</label>
                                        <input type="range" id="imageX" min="-150" max="150" step="1" value="0"
                                               style="width:100px;">
                                        <input type="range" id="imageY" min="-150" max="150" step="1" value="0"
                                               style="width:100px;">
                                    </div>
                                </div>
                            </div>

                            <hr class="my-4">

                            <div class="d-flex justify-content-between">
                                <a asp-action="Index" class="btn btn-secondary btn-lg">
                                    <i class="bi bi-arrow-left"></i> Cancel
                                </a>
                                <button type="submit" class="btn btn-warning btn-lg">
                                    <i class="bi bi-save"></i> Update Entry
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @section Scripts {
        @{
            await Html.RenderPartialAsync("_ValidationScriptsPartial");
        }
        <script>
                            const imageInput = document.getElementById('imageInput');
                            const previewContainer = document.getElementById('imagePreviewContainer');
                            const previewCanvas = document.getElementById('imagePreviewCanvas');
                            const zoomInput = document.getElementById('imageZoom');
                            const xInput = document.getElementById('imageX');
                            const yInput = document.getElementById('imageY');
                            let img = null;
                            let imgLoaded = false;
                            imageInput.addEventListener('change', function (e) {
                                const file = e.target.files[0];
                                if (!file) return;
                                const reader = new FileReader();
                                reader.onload = function (ev) {
                                    img = new window.Image();
                                    img.onload = function () {
                                        imgLoaded = true;
                                        previewContainer.style.display = 'block';
                                        zoomInput.value = 1; // Reset zoom to 1 (no zoom)
                                        xInput.value = 0; // Reset position
                                        yInput.value = 0;
                                        drawImage();
                                    };
                                    img.src = ev.target.result;
                                };
                                reader.readAsDataURL(file);
                            });
                            function drawImage() {
                                if (!imgLoaded) return;
                                const ctx = previewCanvas.getContext('2d');
                                const zoom = parseFloat(zoomInput.value);
                                const x = parseInt(xInput.value);
                                const y = parseInt(yInput.value);
                                previewCanvas.width = 300;
                                previewCanvas.height = 200;
                                ctx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
                                ctx.save();
                                ctx.translate(150 + x, 100 + y);
                                ctx.scale(zoom, zoom);
                                ctx.drawImage(img, -img.width / 2, -img.height / 2);
                                ctx.restore();
                            }
                            zoomInput.addEventListener('input', drawImage);
                            xInput.addEventListener('input', drawImage);
                            yInput.addEventListener('input', drawImage);
        </script>
    }